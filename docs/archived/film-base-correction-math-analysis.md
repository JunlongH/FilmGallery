# 胶片去色罩（片基校正）数学原理分析

**日期**: 2026-01-18  
**状态**: 深度分析 + 实现验证

---

## 1. 问题背景

### 1.1 什么是片基色罩？

彩色负片的片基（Film Base）通常呈现橙色/棕色，这是由以下因素造成的：
- **防光晕层**：片基中添加的橙色染料，用于吸收杂散光
- **遮罩层（Mask）**：用于校正染料非理想光谱吸收的橙色遮罩
- **片基材料**：醋酸纤维素或聚酯片基本身的颜色

扫描负片时，片基颜色会叠加到整个图像上，反转后产生蓝色/青色色偏。

### 1.2 物理模型

负片扫描的透射光遵循 Beer-Lambert 定律：

$$T = 10^{-D}$$

其中：
- $T$ = 透射率 (Transmittance)，即扫描仪读取的原始值 (0-1)
- $D$ = 光密度 (Optical Density)

对于彩色负片，每个通道的透射率可以分解为：

$$T_{ch} = T_{base,ch} \times T_{image,ch}$$

其中：
- $T_{base,ch}$ = 该通道片基的透射率（橙色片基的 R > G > B）
- $T_{image,ch}$ = 该通道图像信息的透射率

---

## 2. 去色罩方法分析

### 2.1 方法 A：乘法增益法（当前实现）

**原理**：通过乘法增益将片基透射率归一化到 1.0（白色）

$$T'_{ch} = T_{ch} \times G_{ch}$$

其中增益 $G_{ch} = \frac{1}{T_{base,ch}}$

**示例**：
- 片基颜色 RGB = (230, 180, 130)，归一化为 (0.902, 0.706, 0.510)
- 计算增益 G = (1.109, 1.417, 1.961)
- 应用增益后：片基 → (1.0, 1.0, 1.0) = 白色

**数学验证**：
```
原始像素: (200, 150, 100) 
          = 片基(230,180,130) × 图像透射率(0.87, 0.83, 0.77)

应用增益后:
R' = 200 × (255/230) = 200 × 1.109 = 221.7
G' = 150 × (255/180) = 150 × 1.417 = 212.5
B' = 100 × (255/130) = 100 × 1.961 = 196.1

→ 片基变白，图像颜色也被校正
```

### 2.2 方法 B：除法法（与乘法等价）

$$T'_{ch} = \frac{T_{ch}}{T_{base,ch}}$$

这在数学上与方法 A 完全等价。

### 2.3 方法 C：对数域减法（密度域）

在对数/密度域中，乘法变成加法：

$$D_{ch} = -\log_{10}(T_{ch}) = -\log_{10}(T_{base,ch}) - \log_{10}(T_{image,ch})$$
$$D_{ch} = D_{base,ch} + D_{image,ch}$$

去色罩变成简单减法：

$$D'_{ch} = D_{ch} - D_{base,ch} = D_{image,ch}$$

**这就是为什么 Film Curve (H&D 模型) 应该在片基校正之前应用的原因**——两者都在密度域操作更自然。

---

## 3. 在 WB 中处理 vs 独立处理

### 3.1 问题：为何不能与 WB 共用状态？

之前的实现将片基校正增益写入 `red`, `green`, `blue`（白平衡增益），存在以下问题：

| 问题 | 描述 |
|------|------|
| **状态覆盖** | 用户调整 Temp/Tint 时，`computeWBGains` 会覆盖片基校正值 |
| **语义混淆** | WB 用于校正光源色温，片基校正用于去除胶片物理特性 |
| **应用位置错误** | WB 在反转后应用，片基校正应在反转前应用 |

### 3.2 正确方案：独立状态 + 正确流水线位置

**独立状态**：
```javascript
// 片基校正增益 (Pre-Inversion)
baseRed, baseGreen, baseBlue  // 默认 1.0

// 场景白平衡增益 (Post-Inversion)
red, green, blue, temp, tint  // 独立调整
```

**流水线位置**：
```
① Film Curve (H&D 密度模型)
② Base Correction (片基校正) ← 这里！
③ Inversion (反转)
④ White Balance (场景白平衡) ← 这里！
⑤ Tone Mapping
...
```

---

## 4. 为什么在反转前应用？

### 4.1 物理正确性

片基颜色是负片的物理属性，存在于**原始扫描数据**中。从物理角度：

1. 扫描仪读取的是**负片的透射率**
2. 透射率 = 片基透射率 × 图像透射率
3. 去色罩 = 除以片基透射率（或乘以增益）
4. **然后**才能正确反转

### 4.2 数学验证

假设：
- 片基 RGB = (0.9, 0.7, 0.5)（橙色）
- 图像透射率 = (0.8, 0.8, 0.8)（灰度）
- 扫描读数 = (0.72, 0.56, 0.40)

**错误方式（反转后校正）**：
```
反转: (0.28, 0.44, 0.60)  ← 蓝色偏移
校正: (0.28×1.11, 0.44×1.43, 0.60×2.00) = (0.31, 0.63, 1.20)
     → 溢出！颜色失真！
```

**正确方式（反转前校正）**：
```
校正: (0.72/0.9, 0.56/0.7, 0.40/0.5) = (0.80, 0.80, 0.80)
     → 中性灰，片基已去除
反转: (0.20, 0.20, 0.20) ← 正确的深灰色
```

---

## 5. 各通道独立处理 vs 统一增益

### 5.1 各通道独立处理（当前实现）

每个通道有独立的增益：$G_R, G_G, G_B$

$$R' = R \times G_R$$
$$G' = G \times G_G$$
$$B' = B \times G_B$$

**优点**：
- 完全中和任意色偏的片基
- 精确匹配采样点颜色

**缺点**：
- 可能改变图像整体亮度
- 如果采样点不是真正的片基，会引入错误校正

### 5.2 保持亮度的变体

可以归一化增益使平均值 = 1：

$$G_{avg} = \frac{G_R + G_G + G_B}{3}$$
$$G'_R = G_R / G_{avg}, \quad G'_G = G_G / G_{avg}, \quad G'_B = G_B / G_{avg}$$

当前实现未采用此方法，因为：
1. 片基本身就是亮区，反转后变成暗区（边框）
2. 后续曝光调整可以补偿亮度变化

---

## 6. 与 Film Curve 的交互

### 6.1 Film Curve 的作用

Film Curve 模拟胶片的 H&D（Hurter-Driffield）密度特性曲线：

$$D_{out} = f(D_{in}) = D_{min} + (D_{max} - D_{min}) \times \left(\frac{D - D_{min}}{D_{max} - D_{min}}\right)^\gamma$$

### 6.2 推荐顺序

```
Raw Scan → Film Curve → Base Correction → Inversion
```

**理由**：
1. Film Curve 在密度域操作，片基影响整个密度范围
2. 先应用 Film Curve 校正密度响应
3. 再应用片基校正去除色偏
4. 最后反转

当前实现已遵循此顺序。

---

## 7. 当前实现总结

### 7.1 流水线顺序

| 步骤 | 操作 | 位置 |
|------|------|------|
| ① | Film Curve | Pre-Inversion |
| ② | Base Correction | Pre-Inversion ✓ |
| ③ | Inversion | - |
| ④ | 3D LUT | Post-Inversion |
| ⑤ | White Balance | Post-Inversion ✓ |
| ⑥ | Tone Mapping | Post-Inversion |

### 7.2 状态管理

| 状态 | 用途 | 默认值 |
|------|------|--------|
| `baseRed/Green/Blue` | 片基校正增益 | 1.0 |
| `red/green/blue` | 手动 RGB 白平衡 | 1.0 |
| `temp/tint` | 色温/色调白平衡 | 0 |

### 7.3 用户操作

| 操作 | 更新状态 | 采样源 |
|------|----------|--------|
| Auto Base | `baseRed/Green/Blue` | 原始图像最亮像素 |
| Pick Base | `baseRed/Green/Blue` | 用户点击位置原始像素 |
| Pick WB | `temp/tint` via solver | 渲染后画布的像素 |

---

## 8. 结论

### 8.1 当前实现是否正确？

**是的**，当前实现在以下方面是正确的：

1. ✅ 使用乘法增益法（物理正确）
2. ✅ 在反转前应用（流水线位置正确）
3. ✅ 各通道独立处理（完全中和片基）
4. ✅ 独立于场景白平衡（不会被覆盖）

### 8.2 是否应该在 WB 中处理？

**不应该**，理由如下：

| 维度 | 片基校正 | 场景白平衡 |
|------|----------|-----------|
| 物理意义 | 去除胶片物理属性 | 校正光源色温 |
| 应用位置 | 反转前 | 反转后 |
| 参考源 | 原始扫描数据 | 渲染后图像 |
| 用户意图 | 消除边框色偏 | 调整画面氛围 |

### 8.3 需要改进的地方

1. ~~`isPickingBase` 仍使用旧的 WB 状态~~ ✅ 已修复
2. 可考虑添加"重置片基"按钮
3. 可考虑添加片基增益的 UI 显示/手动调整

---

## 附录：相关代码位置

| 功能 | 文件 | 函数/位置 |
|------|------|----------|
| 状态定义 | `FilmLab.jsx` | Line ~86 |
| Auto Base | `FilmLab.jsx` | `handleAutoBase` |
| Pick Base | `FilmLab.jsx` | `isPickingBase` handler |
| CPU 处理 | `RenderCore.js` | `processPixel` Step ② |
| WebGL 处理 | `FilmLabWebGL.js` | Shader `main()` Step ② |
| GPU 导出 | `gpu-renderer.js` | Shader base correction |
