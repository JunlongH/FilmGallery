version: '3.8'

services:
  filmgallery:
    # 使用预构建的镜像（推荐）
    image: filmgallery/server:${IMAGE_VERSION:-latest}
    # 如需从源码构建，请取消注释以下两行并注释上面的 image 行
    # build:
    #   context: ..
    #   dockerfile: docker/Dockerfile
    container_name: filmgallery-server
    restart: unless-stopped
    
    # Port mapping
    ports:
      - "${PORT:-4000}:4000"
    
    # Environment variables
    environment:
      - NODE_ENV=production
      - SERVER_MODE=nas
      - PORT=4000
      - TZ=${TZ:-Asia/Shanghai}
      # Database write-through for cloud sync compatibility
      - DB_WRITE_THROUGH=${DB_WRITE_THROUGH:-0}
      
      # ============================================
      # 数据存储路径配置
      # 数据存储在 /mnt/<挂载名>/FilmGallery/ 下
      # ============================================
      - DATA_ROOT=/mnt/storage/FilmGallery
      
      # ============================================
      # 文件系统访问模式配置 (三选一)
      # ============================================
      
      # 模式1: 白名单模式 (最安全)
      # 只允许访问明确指定的目录，逗号分隔
      # - ALLOWED_BROWSE_PATHS=/mnt/photos,/mnt/scans
      
      # 模式2: 挂载目录模式 (推荐，默认启用)
      # 允许访问所有 /mnt 下的挂载目录
      - ALLOW_ALL_MOUNTED_PATHS=true
      
      # 模式3: 完全开放模式 (危险! 仅限测试)
      # 允许访问除系统目录外的所有路径
      # - FILESYSTEM_OPEN_MODE=true
    
    # Volume mounts
    volumes:
      # ============================================
      # 核心数据挂载 (必须配置)
      # 将 NAS 本地目录挂载到容器的 /mnt/xxx/FilmGallery
      # ============================================
      
      # 主存储目录 - 包含数据库和照片
      # 格式: <NAS本地目录>:/mnt/<挂载名>
      # 例如: /volume1/photos:/mnt/photos
      #       数据库将存储在 /mnt/photos/FilmGallery/data
      #       照片将存储在 /mnt/photos/FilmGallery/uploads
      - ${STORAGE_PATH:-/volume1/photos}:/mnt/storage
      
      # ============================================
      # 可选: 额外的只读目录 (用于导入功能)
      # ============================================
      # 如果你想从其他位置导入照片，可以挂载额外目录
      # - /volume1/scans:/mnt/scans:ro
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Resource limits (optional, uncomment if needed)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 512M
    #     reservations:
    #       cpus: '0.5'
    #       memory: 128M

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Named volumes (alternative to bind mounts)
# Uncomment if you prefer Docker-managed volumes
# volumes:
#   filmgallery-data:
#   filmgallery-uploads:
